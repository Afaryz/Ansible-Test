- name: Configure cluster.fw - Datacenter
  ansible.builtin.template:
    src: "cluster.fw.j2"
    dest: /tmp/cluster.fw
    #owner: root # no owner/mode not allowed in pmxcfs
    #group: root
    #mode: '0640'
    #follow: yes
    #unsafe_writes: yes #no tmp file writes because of pmxcfs
- name: Move cluster.fw firewall into cluster
  ansible.builtin.command:
    cmd: mv /tmp/cluster.fw /etc/pve/firewall/cluster.fw
#- name: Configure Node Firewall
#  ansible.builtin.template:
#    src: "host.fw.j2"
#    dest: "/etc/pve/nodes/{{ ansible_hostname }}/host.fw"
#    #owner: root 
#    #group: root
#    #mode: '0640'
#    follow: yes
#    unsafe_writes: yes

#- name: Configure VM Firewall
#  ansible.builtin.template:
#    src: "vm.fw.j2"
#    dest: "{{ '/etc/pve/nodes/' + ansible_hostname + '/host.fw' if item == 'host' else '/etc/pve/firewall/' + item + '.fw' }}"
#    follow: yes
#    unsafe_writes: yes
#  loop: "{{ vm_assignments.keys() | list }}"
#  vars:
#    assigned_sgs: "{{ security_groups | selectattr('name', 'in', vm_assignments[item]) | list }}"

- name: Render firewall template to tmp
  ansible.builtin.template:
    src: "vm.fw.j2"
    dest: "/tmp/{{ item }}.fw"
  loop: "{{ vm_assignments.keys() | list }}"
  vars:
    assigned_sgs: "{{ security_groups | selectattr('name', 'in', vm_assignments[item]) | list }}"

- name: Move firewall into cluster
  ansible.builtin.command:
    cmd: mv /tmp/{{ item }}.fw "{{ '/etc/pve/nodes/' + ansible_hostname + '/host.fw' if item == 'host' else '/etc/pve/firewall/' + item + '.fw' }}" #/etc/pve/firewall/{{ item }}.fw
  loop: "{{ vm_assignments.keys() | list }}"
#- name: Copy firewall to Proxmox cluster
#  ansible.builtin.copy:
#    src: "/tmp/{{ item }}.fw"
#    dest: "/etc/pve/firewall/{{ item }}.fw"
    #owner: root
    #group: root
    #mode: '0644'
#    follow: yes
#    unsafe_writes: yes
#    remote_src: yes
#  loop: "{{ vm_assignments.keys() | list }}"
